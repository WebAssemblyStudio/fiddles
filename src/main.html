<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <style>
    body {
        background-color: white;
    }
  </style>
</head>
<body>
  <div>
    <canvas width="100" height="100"></canvas>
  </div>
  <span id="container"></span>
  <span id="fps"></span>
  <script src="./main.js"></script>
  <script id="vshader" type="webgl/vertexshader">
        attribute vec2 a_coords;
        attribute vec2 a_texcoords;

        varying highp vec2 out_texcoords;
        void main() {
        gl_Position = vec4(a_coords, 0.0, 1.0);
        out_texcoords = a_texcoords;
        }
    </script>
    <script id="fshader" type="webgl/fragmentshader">
        precision mediump float;

        uniform sampler2D u_texture0;
        varying highp vec2 out_texcoords;

        void main() {
        gl_FragColor = texture2D(u_texture0, out_texcoords);
        }
    </script>
    <script>
        startGL.then(function () {
            var canvas = document.getElementsByTagName("canvas")[0];
            var gl = canvas.getContext("webgl");

            /////////////////////////////////////////////// SHADERS
            var vshader = document.getElementById("vshader").innerText;
            var fshader = document.getElementById("fshader").innerText;
            var vsshader = gl.createShader(gl.VERTEX_SHADER);
            gl.shaderSource(vsshader, vshader);
            gl.compileShader(vsshader);
            if (!gl.getShaderParameter(vsshader, gl.COMPILE_STATUS)) {
                console.log(gl.getShaderInfoLog(vsshader));
            }
            var fsshader = gl.createShader(gl.FRAGMENT_SHADER);
            gl.shaderSource(fsshader, fshader);
            gl.compileShader(fsshader);
            if (!gl.getShaderParameter(fsshader, gl.COMPILE_STATUS)) {
                console.log(gl.getShaderInfoLog(fsshader));
            }

            var shaderProgram = gl.createProgram();
            gl.attachShader(shaderProgram, vsshader);
            gl.attachShader(shaderProgram, fsshader);
            gl.linkProgram(shaderProgram);
            var a_coords = gl.getAttribLocation(shaderProgram, 'a_coords');
            var a_texcoords = gl.getAttribLocation(shaderProgram, 'a_texcoords');
            var u_texture0 = gl.getUniformLocation(shaderProgram, 'u_texture0');

            ////////////////////////////////////////////// TEXTURE
            var level = 0;
            var internalFormat = gl.RGBA;
            var width = 100;
            var height = 100;
            var border = 0;
            var srcFormat = gl.RGBA;
            var srcType = gl.UNSIGNED_BYTE;
            var texture = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texImage2D(gl.TEXTURE_2D, level, internalFormat,
                width, height, border, srcFormat, srcType,
                pixel);
            console.log(gl.getError());
            ////////////////////////////////////////// VERTICES
            var positions = new Float32Array([
                -1.0, -1.0,
                +1.0, -1.0,
                +1.0, +1.0,
                -1.0, +1.0,
            ]);
            var positionBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);

            var texCoord = new Float32Array([
                +0.0, +0.0,
                +1.0, +0.0,
                +1.0, +1.0,
                +0.0, +1.0,
            ]);
            var texCoordBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, texCoordBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, texCoord, gl.STATIC_DRAW);

            var indices = new Uint16Array([0, 1, 2, 0, 2, 3]);
            var indexBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
            gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, indices, gl.STATIC_DRAW);

            ///////////////////////////////////////// DRAW
            var fps = document.getElementById("fps");
            var lastTimestamp = null;
            var i = Math.random() * 3;
            var maxDT = 0;
            var maxDTi = 0;
            function render(timestamp) {
                if (!lastTimestamp) lastTimestamp = timestamp - 16;
                var dt = (timestamp - lastTimestamp) * 0.001;
                maxDT += dt;
                maxDTi++;
                lastTimestamp = timestamp;

                if ((timestamp % 10) == 0) {
                    i = Math.random() * 3;
                }

                var txt = "";
                try {
                    if (instance.exports) {
                        instance.exports.set(pixel.buffer);
                    }
                } catch (e) {
                    console.log("error",e);
                }

                gl.bindTexture(gl.TEXTURE_2D, texture);
                gl.texImage2D(gl.TEXTURE_2D, level, internalFormat,
                    width, height, border, srcFormat, srcType,
                    pixel);
                //fps.innerHTML = gl.getError()
                gl.clearColor(0.0, 0.0, 0.0, 1.0);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

                gl.useProgram(shaderProgram);
                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D, texture);
                gl.uniform1i(u_texture0, 0);

                gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
                gl.vertexAttribPointer(a_coords, 2, gl.FLOAT, false, 0, 0);
                gl.enableVertexAttribArray(a_coords);

                gl.bindBuffer(gl.ARRAY_BUFFER, texCoordBuffer);
                gl.vertexAttribPointer(a_texcoords, 2, gl.FLOAT, false, 0, 0);
                gl.enableVertexAttribArray(a_texcoords);

                gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
                gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);

                fps.innerHTML = `${dt.toFixed(4)} - max: ${(maxDT / maxDTi).toFixed(4)} - fps ${(1 / dt).toFixed(4)} `;
                requestAnimationFrame(render);

            };
            requestAnimationFrame(render);
        });
    </script>
</body>
</html>
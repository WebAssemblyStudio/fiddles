//constants for colors
const BLACK = 0x000000;
const WHITE = 0xFFFFFF;

const IMAGE = [0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfcfcfc, 0xfcfcfc, 0xfcfcfc, 0xfefefe, 0xffffff, 0xfefefe, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfdfdfd, 0xfefefe, 0xffffff, 0xfefefe, 0xfdfdfd, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfefefe, 0xfefefe, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfefefe, 0xfefefe, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfdfdfd, 0xfefefe, 0xfefefe, 0xfefefe, 0xfdfdfd, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfefefe, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfefefe, 0xffffff, 0xffffff, 0xd3d2d3, 0xbab9ba, 0xcac9c9, 0xf1f1f1, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfbfbfb, 0xeae9ea, 0xf7f7f7, 0xffffff, 0xf5f5f5, 0xebeaeb, 0xfdfdfd, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfefefe, 0xecebec, 0xf3f3f3, 0xffffff, 0xfefefe, 0xffffff, 0xffffff, 0xffffff, 0xfefefe, 0xffffff, 0xfcfcfc, 0x605d5f, 0x171115, 0x161114, 0x181215, 0xa19fa1, 0xcdcbcc, 0x2b2629, 0xdeddde, 0xefefef, 0xcecdce, 0xffffff, 0xd8d8d8, 0x151013, 0xa09ea0, 0xffffff, 0x8c8a8b, 0x1a1518, 0xe5e5e5, 0xffffff, 0xfdfdfd, 0xfefefe, 0xffffff, 0xf2f2f2, 0x272326, 0x797678, 0xffffff, 0xfbfbfb, 0xfdfdfd, 0xffffff, 0xffffff, 0xfafafa, 0xffffff, 0x9d9b9c, 0x181216, 0x7e7b7d, 0xe6e6e6, 0xcdcccd, 0xf7f7f7, 0xc5c4c5, 0x363234, 0xf8f7f8, 0x969496, 0x161114, 0xf9f9f9, 0xdcdbdc, 0x171215, 0xa4a2a3, 0xffffff, 0x8b898a, 0x171114, 0xe4e4e4, 0xffffff, 0xfefefe, 0xffffff, 0xffffff, 0xf3f3f3, 0x151013, 0x747172, 0xffffff, 0xfbfbfb, 0xffffff, 0xfefefe, 0xffffff, 0xfcfcfc, 0xffffff, 0x585457, 0x221d20, 0xffffff, 0xf3f3f3, 0xdfdedf, 0xf1f1f1, 0xbcbbbb, 0x504c4e, 0xb4b2b3, 0x322e31, 0x161013, 0x3d393c, 0xadacad, 0x161114, 0x5e5b5d, 0xabaaab, 0x524e50, 0x1d181b, 0xb6b4b5, 0x3c383b, 0xcccacb, 0xdddcdd, 0x3c373a, 0xb6b4b5, 0x322e31, 0x252023, 0x2e292c, 0x363234, 0xd2d1d2, 0xffffff, 0xfdfdfd, 0xfdfdfd, 0xffffff, 0x474446, 0x363234, 0xffffff, 0x474345, 0x181216, 0x545153, 0x9f9d9e, 0x181215, 0xb1afb0, 0x535052, 0x161014, 0x878486, 0xbebcbd, 0x181316, 0x181316, 0x1f1a1d, 0x151013, 0x282426, 0xa3a1a2, 0x181216, 0xb8b7b8, 0xcfcecf, 0x181216, 0xa19fa1, 0x2f2a2d, 0x464244, 0xafadae, 0x161114, 0x5e5a5c, 0xffffff, 0xfcfcfc, 0xfbfbfb, 0xffffff, 0x5d595b, 0x1b1619, 0xfafafa, 0xf8f8f8, 0x3c373a, 0x474345, 0xabaaab, 0x171115, 0xefeeee, 0x9f9d9e, 0x161114, 0xffffff, 0xe3e2e2, 0x171114, 0x9a9899, 0xffffff, 0x817f80, 0x191417, 0xaba9aa, 0x161114, 0xc6c5c6, 0xdfdedf, 0x161114, 0xa9a7a8, 0x262225, 0x838082, 0xffffff, 0x3f3b3e, 0x454143, 0xffffff, 0xfefefe, 0xfbfbfb, 0xffffff, 0xaeadae, 0x181215, 0x5b5759, 0xc4c3c4, 0x312c2f, 0x3d393c, 0xa6a4a5, 0x181216, 0xe2e1e1, 0x918f90, 0x171215, 0xbdbcbc, 0xcfcecf, 0x171115, 0x9b999a, 0xffffff, 0x807e7f, 0x151013, 0xa9a7a8, 0x171215, 0x949193, 0xa09e9f, 0x171215, 0xa5a3a4, 0x252124, 0x4e4a4c, 0xd7d6d6, 0x151013, 0x5c585a, 0xffffff, 0xfcfcfc, 0xffffff, 0xfefefe, 0xffffff, 0x8d8b8c, 0x1d181b, 0x161114, 0x171215, 0x858284, 0xb4b2b3, 0x1a1518, 0xe1e0e0, 0xdcdbdc, 0x272326, 0x201b1e, 0xadacad, 0x2c272a, 0xa4a2a3, 0xffffff, 0x928f91, 0x292527, 0xd9d9d9, 0x4f4b4d, 0x161013, 0x332f32, 0x363234, 0xaaa8a9, 0x524e50, 0x393537, 0x1b1619, 0x211c1f, 0xc5c4c5, 0xffffff, 0xfcfcfc, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xf9f9f9, 0xe6e6e6, 0xf0f0f0, 0xffffff, 0xfdfdfd, 0xf7f7f7, 0xfcfcfc, 0xffffff, 0xf7f7f7, 0xe9e9e9, 0xfcfcfc, 0xf8f8f8, 0xfcfcfc, 0xffffff, 0xfbfbfb, 0xf6f6f6, 0xffffff, 0xffffff, 0xe3e3e3, 0xfbfbfb, 0xfefefe, 0xfafafa, 0xf9f9f9, 0xffffff, 0xe8e8e8, 0xf4f4f4, 0xffffff, 0xfefefe, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfbfbfb, 0xffffff, 0xffffff, 0xffffff, 0xfdfdfd, 0xffffff, 0xffffff, 0xffffff, 0xfdfdfd, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfefefe, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfdfdfd, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xffffff, 0xfefefe, 0xfdfdfd, 0xfefefe, 0xffffff, 0xffffff, 0xfefefe, 0xffffff, 0xffffff, 0xfefefe, 0xfdfdfd, 0xffffff, 0xfefefe, 0xffffff, 0xffffff, 0xffffff, 0xfefefe, 0xffffff, 0xfefefe, 0xfdfdfd, 0xfefefe, 0xfefefe, 0xffffff, 0xfefefe, 0xffffff, 0xfdfdfd, 0xfefefe, 0xffffff, 0xffffff, 0xffffff];

const CONT_COLORS = [0xc6e48b, 0x7bc96f, 0x239a3b, 0x196127, 0xfffffff];

const WIDTH = 33;
const HEIGHT = 13;
let CONTRIBUTIONS = [];



function drawFrame(frame) {

  const count = Math.floor(frame.frameNumber / 10);

  // clear canvas
  for (let y = 0; y < frame.height; y++) {
    for (let x = 0; x < frame.width; x++) {
      frame.color = WHITE;
      frame.setPixel(x, y);
    }
  }

  // Draw image at offset
  let positions = [];
  let max = frame.width - WIDTH + 1;
  for (let i = 1; i < max; i++) positions.push(i);
  for (let i = max - 2; i > 1; i--) positions.push(i);

  // Draw image at front of tunnel
  let offset_x = positions[count % positions.length];
  let offset_y = 2;
  for (var i = 0; i < IMAGE.length; i++) {
    let y = Math.floor(i / WIDTH);
    let x = i % WIDTH;

     frame.color = IMAGE[i];
     frame.setPixel(x + offset_x, y + offset_y);
  }

  // Draw image at back of tunnel
  offset_x = max - positions[count % positions.length] - 2; // how far to push logo over
  offset_y = frame.height - HEIGHT - 2;
  for (var i = 0; i < IMAGE.length; i++) {
    let y = Math.floor(i / WIDTH);
    let x = i % WIDTH;

     frame.color = IMAGE[i];
     frame.setPixel(WIDTH - x + offset_x, HEIGHT - y + offset_y);
  }

const num_bars = 7;

  // Conditionally change contributions
  if (frame.frameNumber % 10 === 0) {
      const local = [];
    for (let l = 0; l < num_bars; l++) {
      const rand = Math.floor(Math.random() * CONT_COLORS.length)
      local.push(CONT_COLORS[rand]);
    }
    if (CONTRIBUTIONS.length >= frame.width) {
      CONTRIBUTIONS.pop();
    }
    CONTRIBUTIONS.unshift(local);
  }

  // Draw contributions
  offset_y = Math.floor(frame.height / 2 - 7 / 2);
  for (let x = 0; x < frame.width; x++) {
    const local = CONTRIBUTIONS[x];
    if (!local) continue;
    for (let y = 0; y < num_bars; y++) {
      frame.color = local[y];
      frame.setPixel(x, offset_y + y);
    }
  }
  
}

class Frame {
    constructor(buffer, rows, cols, frameNumber) {
        this.width = cols
        this.height = rows
        this.frameNumber = frameNumber
        this.frameSize = 3 * rows * cols
        //data is a ref to just the slice of the buffer for this frame
        this.data = new Uint8Array(buffer, this.frameSize*this.frameNumber, this.frameSize)
    }

    setPixel(x,y) {
        let n = (y*this.width+x)*3
        this.data[n+0] = (this.color & 0xFF0000) >> 16;
        this.data[n+1] = (this.color & 0x00FF00) >> 8;
        this.data[n+2] = (this.color & 0x0000FF) >> 0;
    }

}


export function transform(buffer, rows, cols, frameCount, fps, isFirst) {
    for (let i = 0; i < frameCount; i++) drawFrame(new Frame(buffer, rows, cols, i))
}

export default function () {
    return Promise.resolve({
        transform,
    })
}
